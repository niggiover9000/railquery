{% include "elements/header.html" %}
<body>
{% include "elements/navbar.html" %}


<div class="container mt-5">
    <h1 class="mb-4 d-inline">Betriebsstellen-Details</h1>
    <span class="badge rounded-pill text-success bg-success-subtle d-inline align-top">Stand: {{ date_db }}</span>
    <hr>
    <div class="row">
        <div class="col-md">
            <ul id="results" class="list-group">
                {% if result %}
                    {% for row in result %}
                        <li class="list-group-item">
                            <div class="d-flex">
                                <div class="p-1 flex-grow-1">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/check-square.svg') }}"
                                         class="align-center me-3" alt="Abgehaktes Kästchen" title="Name">
                                    {% if row[2] != row[3] %}
                                        Langname: {{ row[2] }}
                                    {% else %}
                                        Name: {{ row[2] }}
                                    {% endif %}
                                </div>
                            </div>
                            {% if row[2] != row[3] %}
                                <div class="p-1 flex-grow-1 w-100">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/substack.svg') }}"
                                         class="align-center me-3" alt="Symbol für Kurzname" title="Name">
                                    Kurzname: {{ row[3] }}
                                </div>
                            {% endif %}
                            <div class="p-1 flex-grow-1 w-100">
                                <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/slash-square.svg') }}"
                                     class="align-center me-3" alt="Halb abgehaktes Kästchen" title="RIL-100">
                                RIL100-Kürzel: {{ row[1] }}
                            </div>

                        </li>


                        {% if row[1][0] in region %}
                            <li class="list-group-item d-flex">
                                <div class="p-1 flex-grow-1 flex-grow-1">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/map.svg') }}"
                                         class="align-center me-3" alt="Karte" title="Regionale Lage">
                                    Regionale Lage:
                                    {{ region[row[1][0]] }} ({{ row[1][0] }})

                                </div>
                                <div class="p-1"><img
                                        src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/patch-question.svg') }}"
                                        class="align-center" alt="Fragezeichen" title="Help"></div>
                            </li>
                        {% endif %}
                        {% if row[0] %}
                            <li class="list-group-item d-flex">
                                <div class="p-1 flex-grow-1">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/upc-scan.svg') }}"
                                         class="align-center me-3" alt="Barcode" title="Code">
                                    Code: {{ row[0] }}
                                </div>
                                <div class="p-1"><img
                                        src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/patch-question.svg') }}"
                                        class="align-center" alt="Fragezeichen" title="Help"></div>
                            </li>
                        {% endif %}
                        <li class="list-group-item d-flex">
                            <div class="p-1 flex-grow-1">
                                <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/chat-left-quote.svg') }}"
                                     class="align-center me-3" alt="Sprechblase mit Zitat" title="Typ">
                                {% if row[4].startswith("NE") == True %}
                                    Typ: {{ sonderart["NE-"] }}{{ art[row[4]] }} ({{ row[4] }})
                                {% elif row[4].startswith("vp-") == True %}
                                    Typ: {{ sonderart["vp-"] }} {{ art[row[4] | replace("vp-", "")] }} ({{ row[4] }})
                                {% elif row[4] in art %}
                                    Typ: {{ art[row[4]] }} ({{ row[4] }})
                                {% else %}
                                    Typ: {{ row[4] }}
                                {% endif %}
                            </div>
                            <div class="p-1">
                                <a href="typen">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/patch-question.svg') }}"
                                         class="align-center" data-bs-toggle="tooltip" data-bs-placement="right"
                                         data-bs-custom-class="custom-tooltip" alt="Fragezeichen"
                                         data-bs-title="Es sind verschiedene Typen definiert. Für eine vollständige Liste klicken.">
                                </a>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex">
                                <div class="p-1 flex-grow-1">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/activity.svg') }}"
                                         class="align-center me-3" alt="Herzschlag" title="Betriebszustand">
                                    Betriebszustand: {{ row[5] }}
                                </div>
                                <div class="p-1"><img
                                        src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/patch-question.svg') }}"
                                        class="align-center" alt="Fragezeichen" title="Help"></div>
                            </div>
                            <div class="p-1 w-100 flex-grow-1">
                                <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/calendar-event.svg') }}"
                                     class="align-center me-3" alt="Kalender" title="Betriebszustand seit...">
                                seit: {{ date[0] }}.{{ date[1] }}.{{ date[2] }}
                            </div>

                        </li>
                        </ul>

                        <div class="card list-group mt-3" id="infoContainer-1">
                            <h5 class="card-header"> Externe Links </h5>
                            <div class="card-body">
                                <!-- Gleisplan-Button -->
                                <button class="btn btn-primary mb-1" role="button" id="loadDataBtn-1"
                                        onclick="openTab('https://trassenfinder.de/apn/{{ row[1] }}')" disabled>
                                    Gleisplan herunterladen
                                </button>

                                <button class="btn btn-primary mb-1" role="button" id="loadDataBtn-3"
                                        onclick="openTab('https://stellwerke.info/stw/?ds100={{ row[1] }}')" disabled>
                                    Stellwerks-Infos
                                </button>

                                <button class="btn btn-primary mb-1" role="button" id="loadDataBtn-2"
                                        onclick="openTab('https://iris.noncd.db.de/wbt/js/index.html?bhf={{ row[1] }}')">
                                    Live-Abfahrtszeiten
                                </button>

                                {% if stada_data %}

                                    <button class="btn btn-primary mb-1" role="button" id="loadDataBtn-4"
                                            onclick="openTab('https://www.bahnhof.de/downloads/station-plans/{{ stada_data.number }}.pdf')">
                                        Lageplan anzeigen
                                    </button>

                                    <button class="btn btn-primary mb-1" role="button" id="loadDataBtn-5"
                                            onclick="openTab('https://www.bahnhof.de/downloads/replacement-service-maps/{{ stada_data.number }}.pdf')">
                                        Umgebungsplan anzeigen
                                    </button>

                                    <button class="btn btn-primary mb-1" role="button" id="loadDataBtn-6"
                                            onclick="openTab('https://www.openrailwaymap.org/?style=standard&lat={{ stada_data.ril100Identifiers[0].geographicCoordinates.coordinates[1] }}&lon={{ stada_data.ril100Identifiers[0].geographicCoordinates.coordinates[0] }}&zoom=16')">
                                        OpenRailwayMap
                                    </button>

                                {% endif %}

                                <script>
                                    function openTab(url) {
                                        window.open(url, '_blank');
                                    }

                                    async function checkGleisplan(apn) {
                                        const backendUrl = `${window.location.origin}/api/check-gleisplan/${apn}`;
                                        try {
                                            const response = await fetch(backendUrl);
                                            const data = await response.json();
                                            return data.exists;
                                        } catch (error) {
                                            console.error("Fehler beim API-Call (Gleisplan):", error);
                                            return false;
                                        }
                                    }

                                    async function checkStellwerk(ds100) {
                                        const backendUrl = `${window.location.origin}/api/check-stellwerk/${ds100}`;
                                        try {
                                            const response = await fetch(backendUrl);
                                            const data = await response.json();
                                            return data.exists;
                                        } catch (error) {
                                            console.error("Fehler beim API-Call (Stellwerk):", error);
                                            return false;
                                        }
                                    }

                                    document.addEventListener('DOMContentLoaded', () => {
                                        initButtons();
                                        const code = '{{ row[1] }}';
                                        checkStaDa(code); // Beim Laden ausführen
                                    });

                                    async function checkIris(bhf) {
                                        const backendUrl = `${window.location.origin}/api/check-iris/${bhf}`;
                                        try {
                                            const response = await fetch(backendUrl);
                                            const data = await response.json();
                                            return data.exists;
                                        } catch (error) {
                                            console.error("Fehler beim API-Call (IRIS):", error);
                                            return false;
                                        }
                                    }

                                    async function initButtons() {
                                        const code = '{{ row[1] }}';

                                        const btnGleisplan = document.getElementById('loadDataBtn-1');
                                        const btnIris = document.getElementById('loadDataBtn-2');
                                        const btnStellwerk = document.getElementById('loadDataBtn-3');

                                        if (await checkGleisplan(code)) {
                                            btnGleisplan.disabled = false;
                                        } else {
                                            btnGleisplan.disabled = true;
                                            btnGleisplan.title = "Kein Gleisplan verfügbar";
                                        }

                                        if (await checkIris(code)) {
                                            btnIris.disabled = false;
                                        } else {
                                            btnIris.disabled = true;
                                            btnIris.title = "Keine Live-Daten verfügbar";
                                        }

                                        if (await checkStellwerk(code)) {
                                            btnStellwerk.disabled = false;
                                        } else {
                                            btnStellwerk.disabled = true;
                                            btnStellwerk.title = "Keine Stellwerks-Infos verfügbar";
                                        }
                                    }

                                    document.addEventListener('DOMContentLoaded', initButtons);
                                </script>

                            </div>
                        </div>
                        </div>
                    {% endfor %}
                {% endif %}
        {% if stada_data %}
            <div class="col-md">
                <ul id="results" class="list-group">

                    <div class="col-md">
                        <ul id="resultContainer" class="card list-group">
                            <h5 class="card-header">
                                Weitere Details
                            </h5>
                            <div class="col-md">
                                <li class="list-group-item d-flex">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/geo.svg') }}"
                                         class="align-center me-3"
                                         alt=">Pin-Nadel"
                                         title="Adresse">
                                    {{ stada_data.name }} ({{ stada_data.number }})<br>
                                    {{ stada_data.mailingAddress.street }}<br>
                                    {{ stada_data.mailingAddress.zipcode }} {{ stada_data.mailingAddress.city }}
                                </li>
                                <li class="list-group-item d-flex">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/map.svg') }}"
                                         class="align-center me-3"
                                         alt="Kartensymbol"
                                         title="Regionalbereich">
                                    Regionalbereich:
                                    {{ stada_data.regionalbereich.name }} ({{ stada_data.regionalbereich.number }})
                                    <br>
                                    Aufgabenträger: {{ stada_data.aufgabentraeger.name }}
                                    ({{ stada_data.aufgabentraeger.shortName }})
                                </li>
                                <li class="list-group-item d-flex">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/bookmark-check.svg') }}"
                                         class="align-center me-3" alt="Lesezeichen" title="Bahnhofsart">
                                    Bahnhofsart: {{ stada_data.productLine.productLine }}
                                </li>
                                <li class="list-group-item d-flex">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/tag.svg') }}"
                                         class="align-center me-3"
                                         alt="Preisschild"
                                         title="Bahnhofskategorie">
                                    Bahnhofskategorie: {{ stada_data.category }}
                                </li>
                                <li class="list-group-item d-flex">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/cash-coin.svg') }}"
                                         class="align-center me-3"
                                         alt="Geld" title="Preiskategorie">
                                    Preiskategorie: {{ stada_data.priceCategory }}
                                </li>
                                <li class="list-group-item d-flex">
                                    <img src="{{ url_for('static', filename='img/icons-8-custom/management.svg') }}"
                                         class="align-center me-3"
                                         alt="Köpfe"
                                         title="Bahnhofsmanagement">
                                    Bahnhofsmanagement: {{ stada_data.stationManagement.name }}
                                    ({{ stada_data.stationManagement.number }})
                                </li>
                                <li class="list-group-item d-flex">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/exclamation-triangle.svg') }}"
                                         class="align-center me-3" alt="Ausrufezeichen" title="3-S-Zentrale">
                                    3-S-Zentrale: {{ stada_data.szentrale.name }}
                                    ({{ stada_data.szentrale.number }})<br>
                                    Telefonnummer: {{ stada_data.szentrale.publicPhoneNumber }}
                                </li>
                                <li class="list-group-item d-flex">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/envelope-at.svg') }}"
                                         class="align-center me-3" alt="E-Mail-Symbol" title="Fahrplanzentrale">
                                    Fahrplanzentrale: {{ stada_data.timeTableOffice.email }}<br>
                                    Sitz: {{ stada_data.timeTableOffice.name }}
                                </li>
                                <li class="list-group-item d-flex">
                                    <img src="{{ url_for('static', filename='img/bootstrap-icons-1.11.3/cloud-fog2.svg') }}"
                                         class="align-center me-3" alt="Smoke" title="Zulassung Dampfloks">
                                    Zulassung Dampfloks: {% for ril100 in stada_data.ril100Identifiers %}
                                    {% if ril100.rilIdentifier == result[0][1] %}
                                        {{ ril100.steamPermission }}
                                    {% endif %}
                                {% endfor %}
                                </li>
                                {% for key in [
    'hasTaxiRank', 'hasWiFi', 'hasDBLounge', 'hasParking',
    'hasSteplessAccess', 'hasMobilityService', 'hasBicycleParking',
    'hasLockerSystem', 'hasPublicFacilities', 'hasLostAndFound',
    'hasTravelCenter', 'hasCarRental', 'hasRailwayMission',
    'hasTravelNecessities', 'hasLocalPublicTransport'
] %}
                                    {% set feature_value = stada_data.get(key, False) %}
                                    {{ (key, feature_value) | add_icons | safe }}
                                {% endfor %}
                                <div id="feature-hasLocalPublicTransport"></div>
                                <li class="list-group-item">
                                    <div class="accordion" id="accordionExample">
                                        <div class="accordion-item border-0">
                                            <h2 class="accordion-header" id="headingOne">
                                                <button class="accordion-button collapsed" type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#collapseOne" aria-expanded="false"
                                                        aria-controls="collapseOne">
                                                    Komplette API-Antwort ansehen
                                                </button>
                                            </h2>
                                            <div id="collapseOne" class="accordion-collapse collapse"
                                                 aria-labelledby="headingOne"
                                                 data-bs-parent="#accordionExample">
                                                <div class="accordion-body">
                                                    <pre>{{ stada_data | tojson_utf8 }}</pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </div>
                        </ul>
                    </div>
                </ul>
            </div>
        {% endif %}
    </div>
    {% include "elements/footer.html" %}
</div>
</body>
</html>
